<!DOCTYPE html>
<title>LDTR Demo</title>
<meta charset="utf-8" />

<link rel="stylesheet" href="visualizer.css" />
<style>

  #view {
    font-family: verdana;
    font-size: 12px;
    color: #000;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    overflow: auto;
    padding: 1em 1.5em;
  }

  body.edit #view {
    right: 50%;
  }

  #edit {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 50%;
    overflow: auto;
    visibility: hidden;
  }

  body.edit #edit {
    visibility: visible;
    background-color: #eee;
    box-shadow: 0px 0px 6px 2px rgba(0,0,0,0.4);
    padding: 0.2em;
  }

  .editor {
    visibility: hidden;
    font-family: Courier;
    font-size: 12px;
    width: 99%;
    height: 92%;
  }

  body.edit .editor {
    visibility: visible;
  }

</style>

<section id="view">
</section>
<section id="edit">
  <textarea class="editor" rows="40"></textarea>
  <div class="status"></div>
</section>

<script>var module = {};</script>
<script src="../lib/trig/parser.js"></script>
<script>var trig = module.exports;</script>
<script src="../lib/rdfxml/parser.js"></script>
<script src="../lib/rdfa/contexts.js"></script>
<script src="../lib/rdfa/walker.js"></script>
<script src="../lib/rdfa/parser.js"></script>
<script src="visualizer.js"></script>
<script>

  var ldtrDemo = {

    init: function () {
      this.viewDiv = document.getElementById('view');
      this.editorArea = document.querySelector('#edit > .editor');
      this.statusDiv = document.querySelector('#edit > .status');
      this.editorArea.onkeyup = function () {
        this.parseAndValidate();
      }.bind(this);

      var query = window.location.search.substring(1),
        params = query.split(/\&/).reduce(function (map, pair) {
          var tuple = pair.split(/=/);
          map[tuple[0]] = tuple[1];
          return map;
        }, {});

      if (!params.url || params.edit) {
        document.body.classList.add('edit');
      }

      this.loadData(params.url);
    },

    loadData: function (url, realUrl) {
      if (!url) return;

      var xhtreq = new XMLHttpRequest();
      xhtreq.open('GET', url);
      xhtreq.setRequestHeader('Accept', this.accepts);
      xhtreq.onreadystatechange = function () {
        if (xhtreq.readyState !== XMLHttpRequest.DONE) {
          if (xhtreq.readyState === XMLHttpRequest.LOADING) return;
          if (xhtreq.getResponseHeader('Content-Type').match(/\/(\w+\+)?(x|x?ht)ml/)) {
            xhtreq.responseType = 'document';
          }
          return;
        }
        if (xhtreq.status === 0 && !realUrl) {
          var corsUrl = this.corsResolver + url;
          console.log("Failed CORS, retrying with " + corsUrl);
          this.loadData(corsUrl, url);
          return;
        }
        if (xhtreq.status !== 200) {
          console.log("Failed HTTP request:", xhtreq);
          return;
        }
        this.parseAndValidate(xhtreq, realUrl || url);
        // NOTE: force browser to recognize dynamically generated :target
        if (window.location.hash) {
          window.location = window.location.hash;
        }
      }.bind(this);
      xhtreq.send('');
    },

    parseAndValidate: function (xhtreq, url) {
      var data = null;
      var contentType = 'text/turtle';

      if (xhtreq) {
        contentType = xhtreq.getResponseHeader('Content-Type').replace(/;.*/, '');
        if (xhtreq.responseType === 'document') {
          data = xhtreq.responseXML;
        } else {
          data = this.editorArea.value = xhtreq.responseText;
        }
      } else {
        data = this.editorArea.value;
      }

      var pos = this.editorArea.selectionStart;
      var row = 1;
      var col = 1;
      for (var i=0; i < pos; i++) {
        if (data[i] === '\n') {
          row += 1;
          col = 1;
        } else {
          col++;
        }
      }
      this.statusDiv.innerText = 'Line: '+ row +' Col: '+ col +' \n';

      var parse = this[contentType];
      try {
        var result = parse.call(this, data, url);
        this.statusDiv.innerText += "OK";
      } catch (e) {
        if (!e.location)
          throw e;
        this.statusDiv.innerText += e.name +' at Line: '+ e.location.start.line
          +' Col: '+ e.location.start.column +'\n'+ e.message;
        return;
      }
      visualize(this.viewDiv, result);
    },

    corsResolver: 'http://cors.io/?u=',

    accepts: ['text/turtle', 'text/trig;q=0.9',
      'application/rdf+xml;q=0.8', 'text/xml;q=0.7',
      'text/html;q=0.6'].join(', '),

    'text/trig': function (text) {
      return trig.parse(text);
    },

    'text/turtle': function () {
      return this['text/trig'].apply(this, arguments);
    },

    'application/ld+json': JSON.parse.bind(JSON),

    'application/rdf+xml': function (doc) {
      return RdfXmlParser.parse(doc, new XMLSerializer());
    },

    'text/html': function (doc, url) {
      return RDFaJSONLDParser.parse(doc, url, {compact: true});
    }

  };

  window.onload = ldtrDemo.init();

</script>
